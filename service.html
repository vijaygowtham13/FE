<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Service</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,system-ui,Arial;background:#f9fafb;color:#111827;margin:0;min-height:100vh}
  .top{padding:22px}
  .card{max-width:640px;margin:32px auto;background:#fff;padding:22px;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
  h2{margin:0 0 8px}
  .pricing{display:flex;gap:12px;margin:14px 0}
  .pricebox{background:#f3f4f6;padding:12px;border-radius:8px;min-width:120px;text-align:center}
  .desc{color:#4b5563}
  .bookbtn{margin-top:18px;padding:12px;background:#16a34a;border:none;color:#fff;font-weight:700;border-radius:10px;cursor:pointer;width:100%}
  .bookbtn:hover{background:#15803d}
  /* bottom sheet */
  .sheet{position:fixed;left:0;right:0;bottom:-100%;background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;padding:18px;box-shadow:0 -10px 30px rgba(0,0,0,0.15);transition:bottom 0.35s ease;z-index:50}
  .sheet.open{bottom:0}
  .slots{display:flex;gap:10px;flex-wrap:wrap}
  .slot{background:#f3f4f6;padding:10px 14px;border-radius:8px;cursor:pointer;border:1px solid #e5e7eb}
  .slot:hover{border-color:#16a34a}
  .modeBtns{display:flex;gap:12px;margin-top:12px}
  .modeBtns button{flex:1;padding:10px;border-radius:8px;border:1px solid #e5e7eb;background:#f9fafb;cursor:pointer;font-weight:600}
  .modeBtns .active{background:#16a34a;color:#fff;border:none}
</style>
</head>
<body>
<div class="top">
  <a href="services.html" style="color:#2563eb;text-decoration:none;font-weight:600">&larr; Back</a>
</div>

<div class="card" id="card">
  <h2 id="name">Service</h2>
  <div class="desc" id="description">loading</div>
  <div class="pricing">
    <div class="pricebox">
      <div style="font-size:13px;color:#6b7280">Chat</div>
      <div id="price_chat" style="font-weight:700">--</div>
    </div>
    <div class="pricebox">
      <div style="font-size:13px;color:#6b7280">Video Call</div>
      <div id="price_video" style="font-weight:700">--</div>
    </div>
  </div>
  <button class="bookbtn" id="bookNow">Book Now</button>
</div>

<!-- Bottom sheet -->
<div class="sheet" id="sheet">
  <div style="width:70px;height:6px;background:#d1d5db;border-radius:4px;margin:0 auto 10px;"></div>
  <h3 style="margin:8px 0 12px">Select your slot start time</h3>
  <div class="slots" id="slots"></div>

  <div class="modeBtns" style="margin-top:14px">
    <button id="btnChat" class="active">Chat</button>
    <button id="btnVideo">Video Call</button>
  </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const service_id = params.get('service_id');
let selectedTime = null;
let selectedMode = 'chat';
let serviceData = null;

async function load() {
  const res = await fetch(`http://127.0.0.1:8000/api/services/${service_id}/`);
  serviceData = await res.json();
  document.getElementById('name').innerText = serviceData.name;
  document.getElementById('description').innerText = serviceData.description;
  document.getElementById('price_chat').innerText = serviceData.price_chat + " /-";
  document.getElementById('price_video').innerText = serviceData.price_video + " /-";
}
load();

document.getElementById('bookNow').addEventListener('click', () => {
  const sheet = document.getElementById('sheet');
  sheet.classList.add('open');
  buildSlots();
});

function buildSlots() {
  const times = ["04:00 PM","04:30 PM","05:00 PM","05:30 PM"];
  const slotsEl = document.getElementById('slots');
  slotsEl.innerHTML = '';
  times.forEach(t => {
    const el = document.createElement('div');
    el.className = 'slot';
    el.innerText = t;
    el.onclick = () => {
      document.querySelectorAll('.slot').forEach(x=>x.style.borderColor='#e5e7eb');
      el.style.borderColor = '#16a34a';
      selectedTime = t;
      checkConsultant(t);
    };
    slotsEl.appendChild(el);
  });
}

document.getElementById('btnChat').onclick = () => {
  selectedMode = 'chat';
  document.getElementById('btnChat').classList.add('active');
  document.getElementById('btnVideo').classList.remove('active');
};
document.getElementById('btnVideo').onclick = () => {
  selectedMode = 'video';
  document.getElementById('btnVideo').classList.add('active');
  document.getElementById('btnChat').classList.remove('active');
};

async function checkConsultant(t) {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const slot_date = `${yyyy}-${mm}-${dd}`;

  const res = await fetch(`http://127.0.0.1:8000/api/available-consultant/?service_id=${service_id}&slot_date=${slot_date}&slot_time=${encodeURIComponent(t)}&mode=${selectedMode}`);
  const data = await res.json();
  if(data.consultant_id) {
    const fee = selectedMode === 'chat' ? serviceData.price_chat : serviceData.price_video;
    window.location.href = `booking.html?consultant_id=${data.consultant_id}&service_id=${service_id}&slot_date=${slot_date}&slot_time=${encodeURIComponent(t)}&mode=${selectedMode}&fee=${fee}`;
  } else {
    alert("No consultant available for that slot. Please choose another.");
  }
}
</script>
</body>
</html>
